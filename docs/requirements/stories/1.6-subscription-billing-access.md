# Story 1.6: Subscription & Billing Access

**Epic:** Epic 1: Multi-Tenant Foundation
**Story ID:** 1.6
**Status:** In Progress
**Priority:** High

## User Story

As a **showroom administrator**,
I want **to access billing information and subscription management**,
So that **I can monitor costs and manage my subscription payments**.

## Acceptance Criteria

**Given** I am a showroom administrator
**When** I access billing dashboard
**Then** I see current subscription status, charges, and payment history

**Given** My subscription is due for renewal
**When** I receive renewal notifications
**Then** I can review charges and complete payment through the platform

**Given** I need billing details
**When** I download invoices
**Then** I receive properly formatted billing documents for accounting

## Coverage
- FR10: Subscription and billing management

## Technical Requirements

### Backend Services
- Subscription management service with plan tiers
- Integration with Indonesian payment gateways (Midtrans, Xendit)
- Invoice generation and management system
- Payment processing and webhook handling
- Subscription lifecycle management

### API Endpoints
- GET /api/billing/subscription - Current subscription status
- GET /api/billing/invoices - Invoice history
- POST /api/billing/payment - Process payment
- GET /api/billing/payment-methods - Manage payment methods
- POST /api/billing/subscription/upgrade - Upgrade/downgrade plans

### Frontend Components
- Billing dashboard with subscription overview
- Payment method management interface
- Invoice download and viewing
- Payment processing forms
- Subscription plan comparison

### Indonesian Market Features
- Support for Indonesian payment methods (Bank Transfer, E-Wallet, VA)
- Localized currency formatting (IDR)
- Tax compliance for Indonesian businesses
- Localized billing date formats

## Implementation Details

### Database Schema
```sql
-- Subscription plans
CREATE TABLE subscription_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    price_idr DECIMAL(10,0) NOT NULL,
    features JSONB NOT NULL,
    max_vehicles INTEGER,
    max_users INTEGER,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tenant subscriptions
CREATE TABLE tenant_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    plan_id UUID REFERENCES subscription_plans(id),
    status VARCHAR(50) NOT NULL, -- active, cancelled, past_due
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,
    cancelled_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Invoices
CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    subscription_id UUID REFERENCES tenant_subscriptions(id),
    invoice_number VARCHAR(100) UNIQUE NOT NULL,
    amount_idr DECIMAL(10,0) NOT NULL,
    due_date TIMESTAMP NOT NULL,
    status VARCHAR(50) DEFAULT 'pending', -- pending, paid, overdue, cancelled
    payment_method VARCHAR(100),
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Payments
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    invoice_id UUID REFERENCES invoices(id),
    payment_gateway VARCHAR(50) NOT NULL, -- midtrans, xendit
    gateway_transaction_id VARCHAR(255),
    amount_idr DECIMAL(10,0) NOT NULL,
    status VARCHAR(50) NOT NULL, -- pending, success, failed, refunded
    payment_method VARCHAR(100), -- bank_transfer, ewallet, va
    gateway_response JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Payment Gateway Integration
- **Midtrans**: Core payment processing for credit cards and bank transfers
- **Xendit**: E-wallet integration (OVO, GoPay, DANA)
- **Bank Transfer**: Virtual account generation for major Indonesian banks
- **E-Wallet**: Support for popular Indonesian e-wallet providers

### Security & Compliance
- PCI DSS compliance for payment processing
- Secure storage of payment method information
- Audit logging for all billing operations
- Data encryption for sensitive financial information

## Testing Requirements

### Unit Tests
- Subscription plan calculations and validations
- Payment processing logic
- Invoice generation accuracy
- Tax calculations for Indonesian compliance

### Integration Tests
- Payment gateway webhook handling
- Subscription lifecycle management
- Invoice PDF generation
- Payment method tokenization

### End-to-End Tests
- Complete subscription upgrade flow
- Payment processing from start to finish
- Invoice generation and download
- Multi-currency display (IDR formatting)

## Success Metrics
- Successful payment processing rate > 99%
- Subscription upgrade completion rate > 95%
- Invoice generation accuracy 100%
- Payment gateway response time < 3 seconds

## Dependencies
- Midtrans API integration
- Xendit API integration
- PDF generation library
- Email service for billing notifications
- Tax calculation service for Indonesian compliance

## Notes
- Must support Indonesian tax regulations (PPN 11%)
- Payment gateway redundancy for reliability
- Automated dunning process for overdue payments
- Support for annual and monthly billing cycles