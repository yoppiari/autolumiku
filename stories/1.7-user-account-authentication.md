# Story 1.7: User Account Creation & Authentication

**Epic:** Epic 1: Multi-Tenant Foundation
**Story ID:** 1.7
**Status:** Pending
**Priority:** High

## User Story

As a **showroom team member**,
I want **to create an account with email authentication and password reset**,
So that **I can securely access the platform with standard authentication methods**.

## Acceptance Criteria

**Given** I receive an invitation email
**When** I click the registration link
**Then** I can create my account with email and password

**Given** I have an account
**When** I need to reset my password
**Then** I receive a secure password reset link via email

**Given** I log in successfully
**When** I access the dashboard
**Then** I see my profile information and role-based interface

## Coverage
- FR11: User account creation and authentication

## Technical Requirements

### Backend Services
- User registration service with email verification
- Authentication service with secure password handling
- Password reset service with token-based validation
- Email service for transactional communications
- User profile management service

### API Endpoints
- POST /api/auth/register - User registration
- POST /api/auth/login - User authentication
- POST /api/auth/logout - Session termination
- POST /api/auth/forgot-password - Password reset request
- POST /api/auth/reset-password - Password reset confirmation
- GET /api/auth/verify-email - Email verification
- GET /api/users/profile - User profile retrieval
- PUT /api/users/profile - Profile update

### Frontend Components
- Registration form with validation
- Login form with error handling
- Password reset flow
- Email verification interface
- User profile management
- Security settings page

### Indonesian Market Features
- Indonesian phone number validation (+62 format)
- Bahasa Indonesia language support
- Localized error messages and prompts
- Support for Indonesian email domains

## Implementation Details

### Database Schema
```sql
-- Users table (enhanced for Indonesian market)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20), -- +62 format support
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    is_email_verified BOOLEAN DEFAULT false,
    is_phone_verified BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Email verification tokens
CREATE TABLE email_verification_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Password reset tokens
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Login attempts for security
CREATE TABLE login_attempts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL,
    ip_address INET NOT NULL,
    user_agent TEXT,
    success BOOLEAN NOT NULL,
    attempted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Security Features
- **Password Security**: bcrypt hashing with 12+ rounds
- **Rate Limiting**: 5 failed attempts then 15-minute lockout
- **Session Security**: JWT tokens with 15-minute expiration
- **Email Verification**: Token-based email confirmation
- **Password Reset**: Secure, time-limited reset tokens
- **Account Lockout**: Temporary lock after failed attempts

### Indonesian Phone Validation
```typescript
interface IndonesianPhoneValidation {
  isValidIndonesianPhone(phone: string): boolean;
  formatIndonesianPhone(phone: string): string;
  validatePhoneNumberOTP(phone: string, otp: string): Promise<boolean>;
}

// Support for Indonesian mobile operators
const INDONESIAN_MOBILE_PREFIXES = [
  '+628', '08', '628' // Indonesian mobile prefixes
];
```

### Email Templates (Bahasa Indonesia)
- Welcome email with verification instructions
- Password reset email with secure link
- Account locked notification
- Login attempt alerts
- Email verification reminder

### Authentication Flow
1. **Registration Flow**
   - User fills registration form
   - System validates inputs (email, phone format)
   - Creates user account with unverified email
   - Sends verification email
   - User verifies email to activate account

2. **Login Flow**
   - User enters credentials
   - System validates password
   - Check account lockout status
   - Generate JWT tokens
   - Log successful login attempt
   - Return user profile and permissions

3. **Password Reset Flow**
   - User requests password reset
   - System generates secure token
   - Send reset email with link
   - User validates token and sets new password
   - Invalidate existing sessions

## Testing Requirements

### Unit Tests
- Password hashing and verification
- Email validation logic
- Indonesian phone number format validation
- Token generation and validation
- Rate limiting functionality

### Integration Tests
- Email service integration
- Registration flow end-to-end
- Password reset flow
- Account lockout mechanism
- JWT token generation and validation

### Security Tests
- Brute force attack prevention
- SQL injection prevention
- XSS protection in forms
- CSRF token validation
- Secure password requirements

### Performance Tests
- Login response time < 500ms
- Registration completion time < 2 seconds
- Concurrent user authentication handling
- Email delivery performance

## Success Metrics
- Registration completion rate > 90%
- Email verification rate > 85%
- Password reset success rate > 95%
- Authentication response time < 500ms
- Zero security breaches

## Dependencies
- Email service (SendGrid or similar)
- SMS service for phone verification (optional)
- JWT library for token management
- bcrypt for password hashing
- Rate limiting middleware
- Email template system

## Security Considerations
- GDPR compliance for user data
- Secure password requirements (minimum 8 characters, mixed case, numbers)
- Session management with secure cookies
- Protection against common web vulnerabilities
- Audit logging for authentication events

## Indonesian Compliance
- Support for Indonesian data privacy laws
- Localized consent forms
- Indonesian language interface
- Local date/time formatting
- Support for Indonesian business hours in communications